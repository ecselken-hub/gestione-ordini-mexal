{% extends "base.html" %}

{% block title %}Picking #{{ order.numero }}{% endblock %}

{% block content %}
<input type="text" id="barcode-scanner" autocomplete="off" 
       style="position:fixed; top:-1000px; left:0; opacity:0; z-index:-1;" autofocus>

<div class="pda-header sticky-top bg-white shadow-sm" style="margin: -20px -15px 15px -15px; padding: 15px;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <span class="badge bg-secondary font-mono" style="font-size: 0.9rem;">#{{ order.numero }}</span>
            <span class="fw-bold ms-2 text-truncate" style="max-width: 180px; display:inline-block; vertical-align:middle;">
                {{ order.ragione_sociale }}
            </span>
        </div>
        <div id="connection-status" class="text-success" style="font-size: 0.8rem;">‚óè Online</div>
    </div>

    {% set items_total = order.righe | length %}
    {% set items_done = state.picked_items | length %} 
    <div class="progress" style="height: 25px; background-color: #e9ecef; border-radius: 12px;">
        <div id="picking-progress-bar" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 0%; font-weight:bold;">0%</div>
    </div>
    
    <div class="mt-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center" onclick="document.getElementById('add-collo-btn').click()">
            <span class="text-muted small me-2">COLLO ATTIVO:</span>
            <span id="active-collo-display" class="badge bg-primary p-2" style="font-size: 1.1rem;">-</span>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary fw-bold" id="add-collo-btn" style="border-width: 2px;">
                + NUOVO
            </button>
        </div>
    </div>
</div>

<div id="scan-message" class="alert alert-info py-2 text-center fw-bold mb-2 shadow-sm" style="display:none;"></div>

<div id="picking-workspace" style="padding-bottom: 140px;"> <div class="d-flex mb-3 gap-2">
        <button class="btn btn-sm btn-dark flex-fill active" onclick="filterView('todo')">Da Fare</button>
        <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="filterView('done')">Fatti</button>
        <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="filterView('colli')">Colli</button>
    </div>

    <div id="remaining-items-list" class="list-group list-group-flush">
        </div>

    <div id="packing-list-summary" class="d-none">
        </div>

</div>

<div class="fixed-bottom bg-white border-top p-3 shadow-lg" style="bottom: 60px; z-index: 1000;">
    <form action="{{ url_for('order_action', sigla=order.sigla, serie=order.serie, numero=order.numero) }}" method="POST">
        {% if state.status == 'Da Lavorare' %}
            <button type="submit" name="action" value="start_picking" class="btn btn-primary w-100 btn-lg fw-bold py-3">
                AVVIA PICKING ‚ñ∂
            </button>
        {% elif state.status == 'In Picking' %}
            <input type="hidden" id="colli_totali_operatore" name="colli_totali_operatore" value="0">
            <button type="submit" name="action" value="complete_picking" class="btn btn-success w-100 btn-lg fw-bold py-3">
                COMPLETA (INVIO) ‚úì
            </button>
        {% elif state.status == 'In Controllo' %}
            <div class="row g-2">
                <div class="col-6">
                    <button type="submit" name="action" value="reject_order" class="btn btn-outline-danger w-100 py-3 fw-bold">RIAPRI</button>
                </div>
                <div class="col-6">
                    <button type="submit" name="action" value="approve_order" class="btn btn-success w-100 py-3 fw-bold">APPROVA</button>
                </div>
            </div>
        {% else %}
             <div class="alert alert-success text-center m-0 fw-bold">ORDINE CHIUSO</div>
        {% endif %}
    </form>
</div>

<style>
    /* Card Articolo "Da Fare" - Stile aggressivo e chiaro */
    .pda-item-card {
        border-left: 6px solid #dc3545; /* Rosso default */
        background: white;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 12px;
        transition: transform 0.1s;
    }
    
    .pda-item-card.completed {
        border-left-color: #198754; /* Verde */
        background-color: #f8fff9;
        opacity: 0.7;
    }

    .pda-item-card:active {
        transform: scale(0.98);
        background-color: #f0f0f0;
    }

    /* Testi giganti per codici e qta */
    .big-code { font-size: 1.1rem; font-weight: 700; color: #333; }
    .big-qty { font-size: 1.8rem; font-weight: 800; }
    
    /* Griglia interna alla card */
    .item-grid {
        display: grid;
        grid-template-columns: 1fr auto; 
        gap: 10px;
        align-items: center;
    }

    /* Stepper Buttons giganti */
    .stepper-btn {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        touch-action: manipulation; /* Migliora risposta al tocco */
    }
</style>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 1. CONFIGURAZIONE VARIABILI ---
    const scannerInput = document.getElementById('barcode-scanner');
    const scanMessageDiv = document.getElementById('scan-message');
    const activeColloDisplay = document.getElementById('active-collo-display');
    const remainingListDiv = document.getElementById('remaining-items-list');
    const packingListDiv = document.getElementById('packing-list-summary');
    const progressBar = document.getElementById('picking-progress-bar');
    const colliTotaliInput = document.getElementById('colli_totali_operatore');

    // Dati Stato
    let state = {
        packing_list: {{ state.packing_list | tojson | safe }},
        picked_items: {{ state.picked_items | tojson | safe }},
        status: "{{ state.status }}"
    };
    const orderRows = {{ order.righe | tojson | safe }};
    let activeColloId = state.packing_list.length > 0 ? state.packing_list[state.packing_list.length - 1].collo_id : null;
    
    // API Endpoints
    const apiBase = `/api/order/{{ order.sigla }}/{{ order.serie }}/{{ order.numero }}`;
    const scanApiUrl = `/api/scan-barcode/{{ order.sigla }}/{{ order.serie }}/{{ order.numero }}`;

    // --- 2. FOCUS TRAP PER SCANNER ---
    // Questo √® il segreto dei PDA: il focus deve tornare sempre all'input nascosto
    if(state.status === 'In Picking') {
        setInterval(() => {
            // Non rubare il focus se l'utente sta scrivendo in un altro input visibile (es. note)
            if (document.activeElement.tagName !== 'INPUT' || document.activeElement.id === 'barcode-scanner') {
                scannerInput.focus();
            }
        }, 500); // Check ogni mezzo secondo
        
        // Blur preventivo
        document.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && e.target.tagName !== 'INPUT') {
                scannerInput.focus();
            }
        });
    }

    // --- 3. RENDERING UI "PDA STYLE" ---
    
    function render() {
        renderHeader();
        renderList();
        renderPackingList(); // Renderizza in background
    }

    function renderHeader() {
        if(state.status === 'In Picking') {
            activeColloDisplay.textContent = activeColloId ? activeColloId : "SELEZIONA";
            activeColloDisplay.className = activeColloId ? "badge bg-primary p-2" : "badge bg-danger p-2 animate__animated animate__flash";
            if(colliTotaliInput) colliTotaliInput.value = state.packing_list.length;
        } else {
             activeColloDisplay.textContent = "-";
             activeColloDisplay.className = "badge bg-secondary p-2";
        }

        // Calcolo Progresso Reale
        let totalPieces = 0;
        let pickedPieces = 0;
        
        orderRows.forEach(row => {
            let nr = parseFloat(row.nr_colli || 0);
            let qta = parseFloat(row.quantita || 0);
            let target = nr > 0 ? (nr * qta) : qta;
            if(target === 0) target = 1; // Evita div by zero
            
            totalPieces += target;
            pickedPieces += (state.picked_items[String(row.id_riga)] || 0);
        });

        let percent = totalPieces > 0 ? Math.round((pickedPieces / totalPieces) * 100) : 0;
        if(percent > 100) percent = 100; // Cap at 100 visivo
        
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${percent}%`;
        
        if(percent === 100) {
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
        }
    }

    function renderList() {
        remainingListDiv.innerHTML = '';
        
        // Ordina: Incompleti prima, poi completati
        const sortedRows = [...orderRows].sort((a, b) => {
            const idA = String(a.id_riga);
            const idB = String(b.id_riga);
            const pickedA = state.picked_items[idA] || 0;
            const pickedB = state.picked_items[idB] || 0;
            
            // Logica target
            let tA = parseFloat(a.nr_colli || 0) * parseFloat(a.quantita || 0);
            if(tA === 0) tA = parseFloat(a.quantita || 0);
            let tB = parseFloat(b.nr_colli || 0) * parseFloat(b.quantita || 0);
            if(tB === 0) tB = parseFloat(b.quantita || 0);

            const completeA = pickedA >= tA;
            const completeB = pickedB >= tB;

            if (completeA === completeB) return 0;
            return completeA ? 1 : -1; // Incompleti in alto
        });

        if (sortedRows.length === 0) {
            remainingListDiv.innerHTML = '<div class="text-center p-4 text-muted">Nessuna riga ordine.</div>';
            return;
        }

        sortedRows.forEach(row => {
            const rowId = String(row.id_riga);
            const picked = state.picked_items[rowId] || 0;
            
            let nr = parseFloat(row.nr_colli || 0);
            let qta = parseFloat(row.quantita || 0);
            let target = nr > 0 ? (nr * qta) : qta;
            target = Math.round(target);

            const isComplete = picked >= target;
            
            // HTML CARD OTTIMIZZATA
            const cardHtml = `
            <div class="pda-item-card ${isComplete ? 'completed' : ''}" id="row-${rowId}">
                <div class="item-grid">
                    <div>
                        <div class="font-mono text-muted small">${row.codice_articolo}</div>
                        <div class="fw-bold text-dark" style="line-height:1.2;">${row.descr_articolo}</div>
                        ${row.cod_alternativo && row.cod_alternativo !== 'N/D' ? `<div class="badge bg-light text-dark border mt-1 font-mono">EAN: ${row.cod_alternativo}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <div class="d-flex align-items-center justify-content-end gap-2">
                             <span class="big-qty ${isComplete ? 'text-success' : 'text-danger'}">${picked}</span>
                             <span class="text-muted" style="font-size:1.2rem;">/</span>
                             <span class="big-qty text-dark">${target}</span>
                        </div>
                        <small class="text-muted font-mono">PZ</small>
                    </div>
                </div>

                ${state.status === 'In Picking' ? `
                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                    <button class="btn btn-outline-danger stepper-btn" 
                            onclick="manualAdjust('${row.codice_articolo}', 'remove')">
                        ‚àí
                    </button>
                    
                    <span class="small text-muted text-uppercase fw-bold">Manuale</span>

                    <button class="btn btn-outline-success stepper-btn" 
                            onclick="manualAdjust('${row.codice_articolo}', 'add')">
                        +
                    </button>
                </div>
                ` : ''}
            </div>
            `;
            remainingListDiv.insertAdjacentHTML('beforeend', cardHtml);
        });
    }

    function renderPackingList() {
        // Implementazione semplificata per la vista "Colli"
        let html = '';
        state.packing_list.forEach(collo => {
             const isActive = collo.collo_id === activeColloId;
             html += `<div class="card mb-2 ${isActive ? 'border-primary' : ''}">
                <div class="card-header d-flex justify-content-between">
                    <strong>Collo ${collo.collo_id}</strong>
                    ${state.status === 'In Picking' && !isActive ? `<button class="btn btn-sm btn-primary" onclick="setActiveCollo(${collo.collo_id})">Attiva</button>` : ''}
                </div>
                <div class="card-body p-2">
                    <ul class="mb-0 ps-3">`;
             for(let [code, qta] of Object.entries(collo.items || {})) {
                 html += `<li><span class="font-mono fw-bold">${code}</span>: ${qta}</li>`;
             }
             html += `</ul></div></div>`;
        });
        packingListDiv.innerHTML = html || '<div class="p-3 text-center">Nessun collo</div>';
    }

    // --- 4. LOGICA INTERAZIONE ---

    // Gestione Scanner
    scannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            const barcode = scannerInput.value.trim();
            scannerInput.value = ''; // Pulisci subito
            if(barcode) handleScan(barcode);
        }
    });

    async function handleScan(barcode) {
        if(!activeColloId) {
            feedback("Seleziona o crea un collo prima!", "danger", true);
            return;
        }

        feedback(`Scansione: ${barcode}...`, "info");
        try {
            const res = await fetch(`${scanApiUrl}/collo/${activeColloId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({barcode: barcode})
            });
            const data = await res.json();
            processApiResponse(data);
        } catch(e) {
            feedback("Errore di rete", "danger", true);
        }
    }

    // Gestione Manuale (+/-)
    window.manualAdjust = async function(code, action) {
        if(!activeColloId) {
            feedback("Nessun collo attivo!", "danger", true);
            return;
        }
        
        // Vibrazione feedback tattile immediato
        if(navigator.vibrate) navigator.vibrate(50);

        const url = `${apiBase}/collo/${activeColloId}/item/${action}`;
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({article_code: code})
            });
            const data = await res.json();
            processApiResponse(data);
        } catch(e) {
            feedback("Errore API", "danger", true);
        }
    };

    window.setActiveCollo = function(id) {
        activeColloId = id;
        render();
        filterView('todo'); // Torna alla lista
    };

    // Creazione Collo
    document.getElementById('add-collo-btn')?.addEventListener('click', async () => {
        try {
            const res = await fetch(`${apiBase}/collo/create`, {method: 'POST'});
            const data = await res.json();
            if(data.status === 'success') {
                state.packing_list = data.packing_list;
                activeColloId = data.new_collo_id;
                render();
                feedback(`Creato Collo ${activeColloId}`, "success");
            }
        } catch(e) { feedback("Errore creazione collo", "danger", true); }
    });

    // Helper Risposte
    function processApiResponse(data) {
        if(data.status && (data.status.startsWith('success') || data.status === 'warning_overpick')) {
            state.packing_list = data.packing_list;
            state.picked_items = data.picked_items;
            render();
            
            const isWarning = data.status === 'warning_overpick';
            feedback(data.message, isWarning ? "warning" : "success", isWarning);
            
            // Audio Feedback
            playAudio(isWarning ? 'warn' : 'ok');
            if(navigator.vibrate) navigator.vibrate(isWarning ? [100, 50, 100] : 100);

        } else {
            feedback(data.message || "Errore sconosciuto", "danger", true);
            playAudio('error');
            if(navigator.vibrate) navigator.vibrate(500);
        }
    }

    // Helper Feedback Visivo
    function feedback(msg, type, persistent=false) {
        scanMessageDiv.textContent = msg;
        scanMessageDiv.className = `alert alert-${type} py-2 text-center fw-bold mb-2 shadow-sm fixed-top`;
        scanMessageDiv.style.top = "10px"; 
        scanMessageDiv.style.left = "10px"; 
        scanMessageDiv.style.right = "10px";
        scanMessageDiv.style.zIndex = "2000";
        scanMessageDiv.style.display = 'block';

        if(!persistent) {
            setTimeout(() => { scanMessageDiv.style.display = 'none'; }, 2000);
        }
    }

    // Helper Audio (Sintetizzatore semplice per non caricare file mp3)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playAudio(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'ok') {
            osc.frequency.value = 880; // High beep
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'error') {
            osc.frequency.value = 150; // Low buzz
            osc.type = 'sawtooth';
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        } else {
            osc.frequency.value = 440; 
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }
    }

    // Gestione Tab Filtri
    let currentView = 'todo'; // 'todo', 'done', 'colli'

    function renderList() {
        remainingListDiv.innerHTML = '';
        
        // Ordina: Incompleti prima, poi completati
        const sortedRows = [...orderRows].sort((a, b) => {
            // ... (logica di ordinamento invariata) ...
            const idA = String(a.id_riga);
            const idB = String(b.id_riga);
            const pickedA = state.picked_items[idA] || 0;
            const pickedB = state.picked_items[idB] || 0;
            
            let tA = parseFloat(a.nr_colli || 0) * parseFloat(a.quantita || 0);
            if(tA === 0) tA = parseFloat(a.quantita || 0);
            let tB = parseFloat(b.nr_colli || 0) * parseFloat(b.quantita || 0);
            if(tB === 0) tB = parseFloat(b.quantita || 0);

            const completeA = pickedA >= tA;
            const completeB = pickedB >= tB;

            if (completeA === completeB) return 0;
            return completeA ? 1 : -1; 
        });

        let visibleCount = 0;

        sortedRows.forEach(row => {
            const rowId = String(row.id_riga);
            const picked = state.picked_items[rowId] || 0;
            
            let nr = parseFloat(row.nr_colli || 0);
            let qta = parseFloat(row.quantita || 0);
            let target = nr > 0 ? (nr * qta) : qta;
            target = Math.round(target);

            const isComplete = picked >= target;

            // --- NUOVA LOGICA DI FILTRO ---
            // Se siamo in vista 'todo' e l'articolo √® completo, saltalo
            if (currentView === 'todo' && isComplete) return;
            // Se siamo in vista 'done' e l'articolo NON √® completo, saltalo
            if (currentView === 'done' && !isComplete) return;
            // -----------------------------

            visibleCount++;

            // HTML CARD (Invariato)
            const cardHtml = `
            <div class="pda-item-card ${isComplete ? 'completed' : ''}" id="row-${rowId}">
                <div class="item-grid">
                    <div>
                        <div class="font-mono text-muted small">${row.codice_articolo}</div>
                        <div class="fw-bold text-dark" style="line-height:1.2;">${row.descr_articolo}</div>
                        ${row.cod_alternativo && row.cod_alternativo !== 'N/D' ? `<div class="badge bg-light text-dark border mt-1 font-mono">EAN: ${row.cod_alternativo}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <div class="d-flex align-items-center justify-content-end gap-2">
                             <span class="big-qty ${isComplete ? 'text-success' : 'text-danger'}">${picked}</span>
                             <span class="text-muted" style="font-size:1.2rem;">/</span>
                             <span class="big-qty text-dark">${target}</span>
                        </div>
                        <small class="text-muted font-mono">PZ</small>
                    </div>
                </div>

                ${state.status === 'In Picking' ? `
                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                    <button class="btn btn-outline-danger stepper-btn" 
                            onclick="manualAdjust('${row.codice_articolo}', 'remove')">
                        ‚àí
                    </button>
                    <span class="small text-muted text-uppercase fw-bold">Manuale</span>
                    <button class="btn btn-outline-success stepper-btn" 
                            onclick="manualAdjust('${row.codice_articolo}', 'add')">
                        +
                    </button>
                </div>
                ` : ''}
            </div>
            `;
            remainingListDiv.insertAdjacentHTML('beforeend', cardHtml);
        });

        // Feedback se la lista √® vuota per il filtro corrente
        if (visibleCount === 0) {
            let msg = 'Nessun articolo.';
            if (currentView === 'todo') msg = 'Tutto completato! üéâ';
            if (currentView === 'done') msg = 'Nessun articolo completato.';
            remainingListDiv.innerHTML = `<div class="text-center p-5 text-muted fw-bold">${msg}</div>`;
        }
    }

    // Gestione Tab Filtri Aggiornata
    window.filterView = function(view) {
        currentView = view;

        // 1. Aggiorna stile bottoni
        // Selezioniamo i bottoni tramite la loro posizione o testo, o meglio aggiungiamo ID nell'HTML.
        // Dato che non abbiamo ID, usiamo i selettori CSS basati sull'ordine o onclick
        const buttons = document.querySelectorAll('.d-flex.mb-3.gap-2 button');
        buttons.forEach(btn => {
            // Rimuovi stile attivo da tutti
            btn.classList.remove('btn-dark', 'active');
            btn.classList.add('btn-outline-secondary');
            
            // Aggiungi stile attivo a quello cliccato
            if (btn.getAttribute('onclick').includes(`'${view}'`)) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-dark', 'active');
            }
        });

        // 2. Gestione visibilit√† contenitori
        if(view === 'todo' || view === 'done') {
            remainingListDiv.classList.remove('d-none');
            packingListDiv.classList.add('d-none');
            renderList(); // Ridisegna applicando il filtro
        } else if (view === 'colli') {
            remainingListDiv.classList.add('d-none');
            packingListDiv.classList.remove('d-none');
        }
    };
    render();
});
</script>
{% endblock %}