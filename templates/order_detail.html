{% extends "base.html" %}

{% block title %}Dettaglio Ordine {{ order.numero }}{% endblock %}

{% block content %}
<div class="header">
    <div>
        <h1 style="font-size: 2rem; margin: 0;">Ordine #{{ order.numero }}</h1>
        <p style="color: var(--secondary-text-color); margin: 0; font-weight: 500;">{{ order.ragione_sociale }}</p>
    </div>
    <a href="{{ url_for('ordini_list') }}" class="btn btn-secondary">Lista Ordini</a> {# Mantenuto bottone standard #}
</div>

{# Mantenute card Dati Cliente e Stato Picking semplici #}
<div class="card mb-3">
    <div class="card-header">Dati Cliente</div>
    <div class="card-body">
        <p><strong>Località:</strong> {{ order.localita_effettiva }}</p>
        {% if order.telefono %}<p><strong>Telefono:</strong> {{ order.telefono }}</p>{% endif %}
        {% if order.nota %}<p><strong>Note Ordine:</strong> {{ order.nota }}</p>{% endif %}
        {% if order.pagamento_desc %}<p><strong>Pagamento:</strong> {{ order.pagamento_desc }}</p>{% endif %}
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">Stato Picking</div>
    <div class="card-body">
        <p style="margin: 0;">
            <span style="color: var(--secondary-text-color); font-weight: 500;">Stato Attuale:</span>
            {# Badge stile semplice #}
            <span class="badge
                {% if state.status == 'In Picking' %} bg-primary
                {% elif state.status == 'In Controllo' %} bg-warning text-dark
                {% elif state.status == 'Completato' %} bg-success
                {% else %} bg-secondary {% endif %}">
                {{ state.status }}
            </span>
        </p>
    </div>
</div>

<div class="card">
    <div class="card-header">Articoli da Preparare</div>

    {# Scanner Barcode - Mantenuto ma con stile più semplice #}
    {% if state.status == 'In Picking' %}
    <div class="card-body" style="background-color: #f8f9fa; padding: 1rem; border-bottom: 1px solid #dee2e6;">
        <label for="barcode-scanner" style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Scanner Barcode</label>
        <input type="text" id="barcode-scanner" class="form-control" placeholder="Scansiona codice..." autofocus>
        <div id="scan-message" style="margin-top: 0.75rem; min-height: 20px; font-weight: 500;"></div>
    </div>
    {% endif %}

    {# Form per azioni stato #}
    <form action="{{ url_for('order_action', sigla=order.sigla, serie=order.serie, numero=order.numero) }}" method="POST" id="state-change-form">
        {# Lista Articoli - Ripristino stile precedente #}
        <div class="article-list-container"> {# Contenitore per le righe #}
            {% if order.righe %}
                {% for item in order.righe %}
                    {% set row_id = item.id_riga | string %}
                    {# --- MODIFICA: Calcola qta_ordinata in base a nr_colli --- #}
                    {# Prova a convertire nr_colli in numero #}
                    {% set nr_colli_val = (item.nr_colli | string | replace(',', '.') | float) if item.nr_colli is defined and item.nr_colli is not none and item.nr_colli != '' else 0.0 %}
                    {# Prova a convertire quantita in numero #}
                    {% set quantita_val = (item.quantita | string | replace(',', '.') | float) if item.quantita is defined and item.quantita is not none and item.quantita != '' else 0.0 %}

                    {# Se nr_colli è valido e > 0, usa quello come qta_ordinata #}
                    {% if nr_colli_val > 0 %}
                        {% set qta_ordinata = nr_colli_val %}
                    {# Altrimenti, usa quantita_val #}
                    {% else %}
                        {% set qta_ordinata = quantita_val %}
                    {% endif %}
                    {# --- FINE MODIFICA --- #}
                    {% set qta_prelevata = (state.picked_items.get(row_id, '0') | string | replace(',', '.') | float) if state.picked_items else 0.0 %}
                    {% set is_complete = (qta_prelevata >= qta_ordinata and qta_ordinata > 0) %}
                    
                {# Struttura DIV simile all'immagine 'prima' #}
                <div class="article-row {% if is_complete %}picked-complete-simple{% endif %}" id="order-row-{{ row_id }}">
                    <div class="article-info">
                        <p class="article-description">{{ item.descr_articolo or 'N/D' }}</p>
                        <p class="article-code-simple">Cod: {{ item.codice_articolo }}</p>
                    </div>
                    <div class="article-quantity">
                        <span {% if is_complete %}class="text-success fw-bold"{% endif %}>
                             {# Mostra solo qta ordinata o qta prelevata/ordinata #}
                             {% if state.status == 'In Picking' %}
                                <span class="picked-qty">{{ qta_prelevata | int }}</span> / <span class="ordered-qty">{{ qta_ordinata | int }}</span>
                             {% else %}
                                {{ qta_ordinata | int }} <span style="font-size: 0.8em; color: #6c757d;">Ordinati</span>
                             {% endif %}
                        </span>
                         {# Dettaglio Colli se presente #}
                         {% if item.nr_colli and item.nr_colli > 0 and qta_ordinata > 0 %}
                            {% set pezzi_per_collo = (qta_ordinata / item.nr_colli) %}
                            <small class="d-block text-muted">{{ item.nr_colli | int }} x {{ pezzi_per_collo | int if pezzi_per_collo is integer else "%.2f"|format(pezzi_per_collo) }}</small>
                         {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--secondary-text-color);">Nessun articolo trovato per questo ordine.</div>
            {% endif %}
        </div>

        {# Pulsanti cambio stato - Ripristino stile precedente #}
        <div class="action-footer-simple"> {# Footer stile semplice #}
            {% if state.status == 'Da Lavorare' %}
                <button type="submit" name="action" value="start_picking" class="btn btn-primary btn-lg w-100">Avvia Picking</button>
            {% elif state.status == 'In Picking' %}
                {# Layout come immagine 'dopo' #}
                <div class="mb-3">
                    <label for="colli_totali_operatore" class="form-label">TOTALE COLLI PREPARATI:</label>
                    <input type="number" class="form-control text-center" style="max-width: 100px; display: inline-block; margin-left: 10px;" id="colli_totali_operatore" name="colli_totali_operatore" value="{{ state.colli_totali_operatore or 0 }}" min="0" required>
                </div>
                <button type="submit" name="action" value="complete_picking" class="btn btn-success btn-lg w-100" style="background-color: #34A853; border-color: #34A853;">Completa Picking e Invia a Controllo</button> {# Colore verde simile #}
            {% elif state.status == 'In Controllo' %}
                 <p class="fs-5 mb-3"><strong>Totale Colli Dichiarati: {{ state.colli_totali_operatore or 'N/D' }}</strong></p>
                 <div class="d-flex gap-2 justify-content-center"> {# Bottoni affiancati #}
                     <button type="submit" name="action" value="approve_order" class="btn btn-success btn-lg">Approva Ordine</button>
                     <button type="submit" name="action" value="reject_order" class="btn btn-danger btn-lg">Rimanda al Picking</button>
                 </div>
            {% elif state.status == 'Completato' %}
                 <div class="alert alert-success d-flex align-items-center mb-0" role="alert">
                     {# ... icona successo ... #}
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Success:">
                         <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                     </svg>
                     <div>Ordine Completato</div>
                 </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- CSS AGGIORNATO / RIPRISTINATO -->
<style>
/* Header invariato */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; }
.header h1 { font-size: 1.8rem; }

/* Card semplici */
.card { border: 1px solid #e0e0e0; border-radius: 0.75rem; margin-bottom: 1rem; background-color: #fff; }
.card-header { background-color: #f8f9fa; font-weight: 600; padding: 0.75rem 1rem; border-bottom: 1px solid #e0e0e0;}
.card-body { padding: 1rem; }

/* Badge Stato */
.badge { display: inline-block; padding: .35em .65em; font-size: .75em; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
.bg-primary { background-color: #0d6efd !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-success { background-color: #198754 !important; }
.bg-danger { background-color: #dc3545 !important; }
.bg-warning { background-color: #ffc107 !important; }
.text-dark { color: #212529 !important; }

/* Lista Articoli - Stile semplice con bordi */
.article-list-container { padding: 0; } /* Rimuovi padding se c'era */
.article-row {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Allinea verticalmente */
    padding: 1rem;
    border-bottom: 1px solid #eee;
}
.article-list-container .article-row:last-child {
    border-bottom: none;
}
.article-info {
    flex-grow: 1; /* Occupa spazio disponibile */
    padding-right: 1rem;
}
.article-description {
    font-weight: 500; /* Leggermente bold */
    margin: 0 0 4px 0;
    color: var(--primary-text-color);
}
.article-code-simple { /* Nome classe diverso per evitare conflitti */
    font-size: 0.85rem;
    color: var(--secondary-text-color);
    margin: 0;
}
.article-quantity {
    font-size: 1.2rem; /* Dimensione quantità */
    font-weight: 600;
    text-align: right;
    min-width: 80px; /* Larghezza minima */
    color: var(--primary-text-color);
}
.article-quantity small {
     font-size: 0.75rem;
     font-weight: 400;
}
/* Stile riga completata semplice */
.picked-complete-simple {
     background-color: #e6ffed; /* Sfondo verde chiaro */
     /* Rimosso bordo sinistro per semplicità */
}
.picked-complete-simple .article-description {
     /* text-decoration: line-through; /* Opzionale: barra nome */
}

/* Feedback Scanner */
#scan-message { /* Stile base invariato */
    padding: 0.75rem 1.25rem; border: 1px solid transparent; border-radius: 0.25rem;
    margin-top: 0.75rem; text-align: center; font-weight: 500;
}
#scan-message:empty { display: none; }
#scan-message.text-success { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; }
#scan-message.text-danger { color: #842029; background-color: #f8d7da; border-color: #f5c2c7; }
#scan-message.text-warning { color: #664d03; background-color: #fff3cd; border-color: #ffecb5; }
#scan-message.text-info { color: #055160; background-color: #cff4fc; border-color: #b6effb; }

/* Footer Azioni Semplice */
.action-footer-simple {
    padding: 1rem;
    background-color: #f8f9fa; /* Grigio chiaro */
    border-top: 1px solid #e0e0e0;
    text-align: center; /* Centra contenuto per stato controllo/completato */
}
.action-footer-simple .form-label { font-weight: 500; }

/* Stili base Bootstrap usati */
.btn { display: inline-block; font-weight: 400; line-height: 1.5; color: #212529; text-align: center; text-decoration: none; vertical-align: middle; cursor: pointer; user-select: none; background-color: transparent; border: 1px solid transparent; padding: .375rem .75rem; font-size: 1rem; border-radius: .25rem; transition: all .15s ease-in-out; }
.btn-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
.btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
.btn-outline-secondary { color: #6c757d; border-color: #6c757d; background-color: transparent;}
.btn-outline-secondary:hover { color: #fff; background-color: #6c757d; border-color: #6c757d;}
.btn-success { color: #fff; background-color: #198754; border-color: #198754; }
.btn-danger { color: #fff; background-color: #dc3545; border-color: #dc3545; }
.btn-lg { padding: .5rem 1rem; font-size: 1.25rem; border-radius: .3rem; }
.w-100 { width: 100% !important; }
.mb-0 { margin-bottom: 0 !important; }
.mb-1 { margin-bottom: .25rem !important; }
.mb-2 { margin-bottom: .5rem !important; }
.mb-3 { margin-bottom: 1rem !important; }
.mt-2 { margin-top: .5rem !important; }
.p-3 { padding: 1rem !important; }
.px-4 { padding-right: 1.5rem !important; padding-left: 1.5rem !important; }
.text-center { text-align: center !important; }
.text-muted { color: #6c757d !important; }
.fw-bold { font-weight: 700 !important; }
.fs-5 { font-size: 1.25rem !important; }
.d-block { display: block !important; }
.d-flex { display: flex !important; }
.gap-2 { gap: .5rem !important; }
.justify-content-center { justify-content: center !important; }
.align-items-center { align-items: center !important; }
.form-control { display: block; width: 100%; padding: .375rem .75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #212529; background-color: #fff; background-clip: padding-box; border: 1px solid #ced4da; appearance: none; border-radius: .25rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
.form-control-lg { min-height: calc(1.5em + 1rem + 2px); padding: .5rem 1rem; font-size: 1.25rem; border-radius: .3rem; }
.form-label { margin-bottom: .5rem; }
.alert { position: relative; padding: 1rem 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
.alert-success { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; }
.flex-shrink-0 { flex-shrink: 0 !important; }
.me-2 { margin-right: .5rem !important; }

</style>

<!-- JAVASCRIPT (INVARIATO DALLA VERSIONE PRECEDENTE CON URL CORRETTO) -->
{% if state.status == 'In Picking' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scannerInput = document.getElementById('barcode-scanner');
    const scanMessageDiv = document.getElementById('scan-message');
    const apiUrl = `/api/scan-barcode/{{ order.sigla }}/{{ order.serie }}/{{ order.numero }}`;
    console.log("API URL per scansione (effettivo):", apiUrl);

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(type = 'success') {
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.value = 0.1;
            if (type === 'success') {
                oscillator.frequency.value = 880; oscillator.type = 'sine';
            } else {
                oscillator.frequency.value = 300; oscillator.type = 'square';
            }
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        } catch (e) { console.error("AudioContext non supportato o errore:", e); }
    }

    if (scannerInput) {
        scannerInput.focus();
        scannerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                const barcode = scannerInput.value.trim();
                if (barcode === '') return;
                handleBarcodeScan(barcode);
            }
        });
    }

    async function handleBarcodeScan(barcode) {
        showScanFeedback('Verifica barcode...', 'info');
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                body: JSON.stringify({ barcode: barcode }),
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                 let errorMessage = `Errore HTTP ${response.status}: ${response.statusText}`;
                 try { const errData = await response.json(); errorMessage = errData.message || errorMessage; } catch (jsonError) { /* ignore */ }
                 console.error("Errore risposta Fetch:", response.status, response.statusText);
                 throw new Error(errorMessage);
            }
            const data = await response.json();
            console.log("API Response:", data);

            if (data.status === 'success' && data.item) {
                showScanFeedback(`OK: ${data.item.codice_articolo} (${data.item.qta_prelevata}/${data.item.qta_ordinata})`, 'success');
                playBeep('success');
                updateRowUI(data.item.id_riga, data.item.qta_prelevata, data.item.qta_ordinata);
            } else if (data.status === 'already_picked') {
                showScanFeedback(`${data.message}`, 'warning');
                playBeep('warning');
            } else if (data.status === 'item_not_in_order' || data.status === 'not_found') {
                 showScanFeedback(`❌ ${data.message}`, 'danger');
                 playBeep('error');
            } else {
                 showScanFeedback(`❌ Errore: ${data.message || 'Risposta non valida dal server'}`, 'danger');
                 playBeep('error');
            }
        } catch (err) {
            console.error('Fetch Error o Errore Risposta:', err);
            showScanFeedback(`Errore: ${err.message}`, 'danger');
            playBeep('error');
        } finally {
            scannerInput.value = '';
            scannerInput.focus();
        }
    }

    function showScanFeedback(message, type = 'info') {
        if (!scanMessageDiv) return;
        scanMessageDiv.textContent = message;
        scanMessageDiv.className = `text-${type} mt-2`;
        setTimeout(() => {
            if (scanMessageDiv.textContent === message) {
               scanMessageDiv.textContent = '';
               scanMessageDiv.className = 'mt-2';
            }
        }, 5000);
    }

    function updateRowUI(rowId, pickedQtyStr, orderedQtyStr) {
        const rowElement = document.getElementById(`order-row-${rowId}`);
        if (!rowElement) { console.warn(`Elemento riga non trovato per ID: ${rowId}`); return; }
        const pickedQtySpan = rowElement.querySelector('.picked-qty');
        const orderedQtySpan = rowElement.querySelector('.ordered-qty'); // Potremmo usarlo per riferimento
        const quantityContainer = rowElement.querySelector('.article-quantity span:first-child'); // Seleziona il contenitore della quantità

        const pickedQty = parseFloat(String(pickedQtyStr).replace(',', '.')) || 0;
        const orderedQty = parseFloat(String(orderedQtyStr).replace(',', '.')) || 0;

        if (pickedQtySpan && orderedQtySpan) {
             // Aggiorna solo la quantità prelevata
            pickedQtySpan.textContent = Math.round(pickedQty);
            // La quantità ordinata non dovrebbe cambiare
            // orderedQtySpan.textContent = Math.round(orderedQty);
        }

        // Aggiorna stile riga e badge quantità
        if (orderedQty > 0 && pickedQty >= orderedQty) {
            rowElement.classList.add('picked-complete-simple');
            if(quantityContainer) { // Cambia stile del contenitore quantità
                 quantityContainer.classList.remove('text-dark'); // Assumendo che non ci sia bg-light qui
                 quantityContainer.classList.add('text-success', 'fw-bold');
            }
        } else {
            rowElement.classList.remove('picked-complete-simple');
             if(quantityContainer) { // Ripristina stile
                 quantityContainer.classList.remove('text-success', 'fw-bold');
                 quantityContainer.classList.add('text-dark'); // O il colore di default
            }
        }
    }
});
</script>
{% endif %}
<!-- FINE JAVASCRIPT -->

{% endblock %}

